<!DOCTYPE html>
<html lang="en">
<head>
   <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Upload Certificates</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- easy vue table -->
    <link href="https://unpkg.com/vue3-easy-data-table/dist/style.css" rel="stylesheet">
    <script src="https://unpkg.com/vue3-easy-data-table"></script>
     <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <style>
        .upload-form {
            border: 2px dashed #ccc;
            padding: 20px;
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .preview {
            margin-top: 20px;
        }

        .customize-table {
            --easy-table-border: 1px solid #dee2e6;
            --easy-table-row-border: 1px solid #dee2e6;
            width: 100%;
            max-width: 100%;
        }

    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="row">
                <h1>Certificados</h1>
                <div class="upload-form">
                    <form @submit.prevent="handleSubmit">
                        <div class="form-group">
                            <label for="document">Seleccione un archivo .zip:</label>
                            <input 
                                type="file" 
                                id="document" 
                                ref="fileInput"
                                required
                                @change="handleFileChange"
                            >
                        </div>
                        <button type="submit">Subir</button>
                    </form>
                </div>

                <!-- Agregamos la tabla -->
                <div v-if="dataTable ">
                    <h2> Estado de los archivos subidos</h2>
                    <easy-data-table 
                    :headers="headers"
                    :items="dataTable"
                    :rows-per-page="10"
                    :rows-items="[10, 20, 50]"
                    table-class-name="customize-table"
                    :border-cell="true"
                    />
                </div>
            </div>
        </div>   
        
        <!-- Modal -->
        <div   class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Estado</h5>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-center align-items-center gap-2">
                        <div class="spinner-border text-primary" style="width: 1.7rem; height: 1.7rem;" role="status">
                            <span class="visually-hidden ">Loading...</span>
                        </div>
                        <div class="spinner-text">
                            <p class="m-0">Subiendo certificados...</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue

        const app = createApp({
            components: {
                'easy-data-table': window['vue3-easy-data-table']
            },

            setup() {            
                const fileInput = ref(null)
                const dataTable = ref(null)

                // Modal para mostrar el estado de los certificados subidos
                const modalInstance = ref(null)
                const isBootstrapLoaded = ref(false)
                const isModalOpen = ref(true)

                const headers = [
                    { text: "Certificado", value: "carpeta",  },
                    { text: "Archivo", value: "nombre",  },
                    { text: "Estado", value: "status",  },
                    { text: "Mensaje", value: "message",  },
                ];

                const handleFileChange = (event) => {
                    console.log(event);
                }

                const handleSubmit = async () => {
                    
                    if (modalInstance.value) {
                        modalInstance.value.show()
                    }

                    const formData = new FormData()
                    const file = fileInput.value.files[0]
                    formData.append('file', file)

                    try {
                        const response = await fetch('/upload-files', {
                            method: 'POST',
                            body: formData
                        })
                        isModalOpen.value = true
                        console.log('isModalOpen change', isModalOpen.value);
                        const data = await response.json()
                        console.log(data);
                        console.log(data.mensaje);

                        dataTable.value = data.estructura.urls_archivos
                        if (modalInstance.value) {
                            modalInstance.value.hide()
                        }

                    } catch (error) {
                        if (modalInstance.value) {
                            modalInstance.value.hide()
                        }
                    }
                }

                // Función para verificar si Bootstrap está disponible
                const checkBootstrap = () => {
                    return typeof window !== 'undefined' && window.bootstrap && window.bootstrap.Modal
                }
                const initModal = () => {
                    if (checkBootstrap()) {
                        const modalElement = document.getElementById('myModal')
                            if (modalElement) {
                                modalInstance.value = new window.bootstrap.Modal(modalElement)
                                isBootstrapLoaded.value = true
                                console.log('Modal inicializado correctamente')
                            } else {
                                console.warn('Elemento del modal no encontrado')
                            }
                    } else {
                        console.warn('Bootstrap no está completamente cargado')
                    }
                }

                // Funciones para controlar el modal
                const showModal = () => {
                    if (modalInstance.value) {
                        modalInstance.value.show()
                    }
                }

                const hideModal = () => {
                    if (modalInstance.value) {
                        modalInstance.value.hide()
                    }
                }
                onMounted(() => {
                    // Esperamos un poco más para asegurar que Bootstrap esté cargado
                    setTimeout(() => {
                        initModal()
                        // Si no se cargó, intentamos nuevamente después de un momento
                        if (!isBootstrapLoaded.value) {
                            setTimeout(initModal, 500)
                        }
                    }, 100)
                })

                return {
                    headers,
                    fileInput,
                    dataTable,
                    handleFileChange,
                    handleSubmit,
                    showModal,
                    hideModal,
                    modalInstance,
                    isModalOpen,
                    isBootstrapLoaded,
                }
            }
        })
        app.mount('#app')
    </script>
    
    
   
</body>
</html>